<?php
class MP{ } class WoniuInput { public static $router; public static function route_query() { return self::$router['query']; } public static function module_name() { return self::$router['module']; } public static function method_path() { return self::$router['mpath']; } public static function method_name() { return self::$router['m']; } public static function method_prefix() { return self::$router['prefix']; } public static function controller_path() { return self::$router['cpath']; } public static function controller_name() { return self::$router['c']; } public static function folder_name() { return self::$router['folder']; } public static function controller_file() { return self::$router['file']; } public static function class_name() { return self::$router['class']; } public static function class_method_name() { return self::$router['method']; } public static function parameters($key = null) { if (!is_null($key)) { if (isset(self::$router['parameters'][$key])) { return self::$router['parameters'][$key]; } else { return null; } } else { return self::$router['parameters']; } } private static function get_x_type($rule, $method, $key) { $val = null; switch ($method) { case 'get': $val = self::get($key); break; case 'post': $val = self::post($key); break; case 'get_post': $val = self::get_post($key); break; case 'post_get': $val = self::post_get($key); break; } if (is_null(MpLoader::checkData($rule, array('check' => $val)))) { return $val; } else { return null; } } private static function get_rule_type($rule, $method, $key, $default = null) { if (!is_array($rule)) { $_rule = array($rule => 'err'); } else { $_rule = array(); foreach ($rule as $r) { $_rule[$r] = 'err'; } } $rule = array('check' => $_rule); $val = self::get_x_type($rule, $method, $key); return is_null($val) ? $default : $val; } public static function get_rule($rule, $key, $default = null) { return self::get_rule_type($rule, 'get', $key, $default); } public static function post_rule($rule, $key, $default = null) { return self::get_rule_type($rule, 'post', $key, $default); } public static function get_post_rule($rule, $key, $default = null) { return self::get_rule_type($rule, 'get_post', $key, $default); } public static function post_get_rule($rule, $key, $default = null) { return self::get_rule_type($rule, 'post_get', $key, $default); } private static function get_int_type($method, $key, $min = null, $max = null, $default = null) { $val = self::get_rule_type('int', $method, $key); $min_okay = is_null($min) || (!is_null($min) && $val >= $min); $max_okay = is_null($max) || (!is_null($max) && $val <= $max); return $min_okay && $max_okay && !is_null($val) ? $val : $default; } public static function get_int($key, $min = null, $max = null, $default = null) { return self::get_int_type('get', $key, $min, $max, $default); } public static function post_int($key, $min = null, $max = null, $default = null) { return self::get_int_type('post', $key, $min, $max, $default); } public static function get_post_int($key, $min = null, $max = null, $default = null) { return self::get_int_type('get_post', $key, $min, $max, $default); } public static function post_get_int($key, $min = null, $max = null, $default = null) { return self::get_int_type('post_get', $key, $min, $max, $default); } private static function get_date_type($method, $key, $min = null, $max = null, $default = null) { $val = self::get_rule_type('date', $method, $key); $min_okay = is_null($min) || (!is_null($min) && strtotime($val) >= strtotime($min)); $max_okay = is_null($max) || (!is_null($max) && strtotime($val) <= strtotime($max)); return $min_okay && $max_okay && !is_null($val) ? $val : $default; } public static function get_date($key, $min = null, $max = null, $default = null) { return self::get_date_type('get', $key, $min, $max, $default); } public static function post_date($key, $min = null, $max = null, $default = null) { return self::get_date_type('post', $key, $min, $max, $default); } public static function get_post_date($key, $min = null, $max = null, $default = null) { return self::get_date_type('get_post', $key, $min, $max, $default); } public static function post_get_date($key, $min = null, $max = null, $default = null) { return self::get_date_type('post_get', $key, $min, $max, $default); } private static function get_time_type($method, $key, $min = null, $max = null, $default = null) { $val = self::get_rule_type('time', $method, $key); $pre_fix = '2014-01-01 '; $min_okay = is_null($min) || (!is_null($min) && strtotime($pre_fix . $val) >= strtotime($pre_fix . $min)); $max_okay = is_null($max) || (!is_null($max) && strtotime($pre_fix . $val) <= strtotime($pre_fix . $max)); return $min_okay && $max_okay && !is_null($val) ? $val : $default; } public static function get_time($key, $min = null, $max = null, $default = null) { return self::get_time_type('get', $key, $min, $max, $default); } public static function post_time($key, $min = null, $max = null, $default = null) { return self::get_time_type('post', $key, $min, $max, $default); } public static function get_post_time($key, $min = null, $max = null, $default = null) { return self::get_time_type('get_post', $key, $min, $max, $default); } public static function post_get_time($key, $min = null, $max = null, $default = null) { return self::get_time_type('post_get', $key, $min, $max, $default); } private static function get_datetime_type($method, $key, $min = null, $max = null, $default = null) { $val = self::get_rule_type('datetime', $method, $key); $min_okay = is_null($min) || (!is_null($min) && strtotime($val) >= strtotime($min)); $max_okay = is_null($max) || (!is_null($max) && strtotime($val) <= strtotime($max)); return $min_okay && $max_okay && !is_null($val) ? $val : $default; } public static function get_datetime($key, $min = null, $max = null, $default = null) { return self::get_datetime_type('get', $key, $min, $max, $default); } public static function post_datetime($key, $min = null, $max = null, $default = null) { return self::get_datetime_type('post', $key, $min, $max, $default); } public static function get_post_datetime($key, $min = null, $max = null, $default = null) { return self::get_datetime_type('get_post', $key, $min, $max, $default); } public static function post_get_datetime($key, $min = null, $max = null, $default = null) { return self::get_datetime_type('post_get', $key, $min, $max, $default); } public static function get_post($key = null, $default = null, $xss_clean = false) { $get = self::gpcs('_GET', $key,NULL); $val = $get === null ? self::gpcs('_POST', $key, $default) : $get; return $xss_clean ? self::xss_clean($val) : $val; } public static function post_get($key = null, $default = null, $xss_clean = false) { $get = self::gpcs('_POST', $key,NULL); $val = $get === null ? self::gpcs('_GET', $key, $default) : $get; return $xss_clean ? self::xss_clean($val) : $val; } public static function get($key = null, $default = null, $xss_clean = false) { $val = self::gpcs('_GET', $key, $default); return $xss_clean ? self::xss_clean($val) : $val; } public static function post($key = null, $default = null, $xss_clean = false) { $val = self::gpcs('_POST', $key, $default); return $xss_clean ? self::xss_clean($val) : $val; } public static function cookie($key = null, $default = null, $xss_clean = false) { $key = systemInfo('cookie_key_prefix') . $key; return self::cookieRaw($key, $default, $xss_clean); } public static function cookieRaw($key = null, $default = null, $xss_clean = false) { $val = self::gpcs('_COOKIE', $key, $default); return $xss_clean ? self::xss_clean($val) : $val; } public static function session($key = null, $default = null) { return self::gpcs('_SESSION', $key, $default); } public static function server($key = null, $default = null) { $key = !is_null($key) ? strtoupper($key) : null; return self::gpcs('_SERVER', $key, $default); } private static function gpcs($range, $key, $default) { global $$range; if ($key === null) { return $$range; } else { $range = $$range; return isset($range[$key]) ? $range[$key] : ( $default !== null ? $default : null); } } public static function isCli() { return php_sapi_name() == 'cli'; } public static function is_cli() { return self::isCli(); } public static function is_ajax() { return (self::server('HTTP_X_REQUESTED_WITH') === 'XMLHttpRequest'); } public static function xss_clean($var) { if (is_array($var)) { foreach ($var as $key => $val) { if (is_array($val)) { $var[$key] = self::xss_clean($val); } else { $var[$key] = self::xss_clean0($val); } } } elseif (is_string($var)) { $var = self::xss_clean0($var); } return $var; } private static function xss_clean0($data) { $data = str_replace(array('&amp;', '&lt;', '&gt;'), array('&amp;amp;', '&amp;lt;', '&amp;gt;'), $data); $data = preg_replace('/(&#*\w+)[\x00-\x20]+;/u', '$1;', $data); $data = preg_replace('/(&#x*[0-9A-F]+);*/iu', '$1;', $data); $data = html_entity_decode($data, ENT_COMPAT, 'UTF-8'); $data = preg_replace('#(<[^>]+?[\x00-\x20"\'])(?:on|xmlns)[^>]*+>#iu', '$1>', $data); $data = preg_replace('#([a-z]*)[\x00-\x20]*=[\x00-\x20]*([`\'"]*)[\x00-\x20]*j[\x00-\x20]*a[\x00-\x20]*v[\x00-\x20]*a[\x00-\x20]*s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:#iu', '$1=$2nojavascript...', $data); $data = preg_replace('#([a-z]*)[\x00-\x20]*=([\'"]*)[\x00-\x20]*v[\x00-\x20]*b[\x00-\x20]*s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:#iu', '$1=$2novbscript...', $data); $data = preg_replace('#([a-z]*)[\x00-\x20]*=([\'"]*)[\x00-\x20]*-moz-binding[\x00-\x20]*:#u', '$1=$2nomozbinding...', $data); $data = preg_replace('#(<[^>]+?)style[\x00-\x20]*=[\x00-\x20]*[`\'"]*.*?expression[\x00-\x20]*\([^>]*+>#i', '$1>', $data); $data = preg_replace('#(<[^>]+?)style[\x00-\x20]*=[\x00-\x20]*[`\'"]*.*?behaviour[\x00-\x20]*\([^>]*+>#i', '$1>', $data); $data = preg_replace('#(<[^>]+?)style[\x00-\x20]*=[\x00-\x20]*[`\'"]*.*?s[\x00-\x20]*c[\x00-\x20]*r[\x00-\x20]*i[\x00-\x20]*p[\x00-\x20]*t[\x00-\x20]*:*[^>]*+>#iu', '$1>', $data); $data = preg_replace('#</*\w+:\w[^>]*+>#i', '', $data); do { $old_data = $data; $data = preg_replace('#</*(?:applet|b(?:ase|gsound|link)|embed|iframe|frame(?:set)?|i(?:frame|layer)|l(?:ayer|ink)|meta|object|s(?:cript|tyle)|title|xml)[^>]*+>#i', '', $data); } while ($old_data !== $data); return $data; } } class MpInput extends WoniuInput{} class WoniuRouter { public static function loadClass() { $system = systemInfo(); $methodInfo = self::parseURI(); MpLoader::classAutoloadRegister(); if (file_exists($methodInfo['file'])) { include $methodInfo['file']; MpInput::$router = $methodInfo; if (!MpInput::isCli()) { self::checkSession(); } $class = new $methodInfo['class'](); if (method_exists($class, $methodInfo['method'])) { $methodInfo['parameters'] = is_array($methodInfo['parameters']) ? $methodInfo['parameters'] : array(); if (method_exists($class, '__output')) { ob_start(); call_user_func_array(array($class, $methodInfo['method']), $methodInfo['parameters']); $buffer = ob_get_contents(); @ob_end_clean(); call_user_func_array(array($class, '__output'), array($buffer)); } else { call_user_func_array(array($class, $methodInfo['method']), $methodInfo['parameters']); } } else { trigger404($methodInfo['class'] . ':' . $methodInfo['method'] . ' not found.'); } } else { if ($system['debug']) { trigger404('file:' . $methodInfo['file'] . ' not found.'); } else { trigger404(); } } } private static function parseURI() { $pathinfo_query = self::getQueryStr(); $router['module'] = self::getHmvcModuleName($pathinfo_query); $pathinfo_query = self::checkHmvc($pathinfo_query); $pathinfo_query = self::checkRouter($pathinfo_query); $router['query'] = $pathinfo_query; $system = systemInfo(); $class_method = $system['default_controller'] . '.' . $system['default_controller_method']; if (!empty($pathinfo_query)) { $pathinfo_query = ltrim($pathinfo_query, '/'); $requests = explode("/", $pathinfo_query); preg_match('/[^&]+(?:\.[^&]+)+=?/', $requests[0]) ? $class_method = $requests[0] : null; if (strstr($class_method, '&') !== false) { $cm = explode('&', $class_method); $class_method = trim($cm[0], "="); } } $class_method = trim($class_method, "="); $pathinfo_query = str_replace($class_method, '', $pathinfo_query); $pathinfo_query_parameters = explode("&", $pathinfo_query); $pathinfo_query_parameters_str = !empty($pathinfo_query_parameters[0]) ? $pathinfo_query_parameters[0] : ''; $pathinfo_query_parameters_str && $pathinfo_query_parameters_str{0} === '/' ? $pathinfo_query_parameters_str = substr($pathinfo_query_parameters_str, 1) : ''; $origin_class_method = $class_method; $class_method = explode(".", $class_method); $method = end($class_method); $method = $system['controller_method_prefix'] . ($system['controller_method_ucfirst'] ? ucfirst($method) : $method); unset($class_method[count($class_method) - 1]); $file = $system['controller_folder'] . DIRECTORY_SEPARATOR . implode(DIRECTORY_SEPARATOR, $class_method) . $system['controller_file_subfix']; $class = $class_method[count($class_method) - 1]; $parameters = explode("/", $pathinfo_query_parameters_str); if (count($parameters) === 1 && empty($parameters[0])) { $parameters = array(); } foreach ($parameters as $key => $value) { $parameters[$key] = urldecode($value); } $info = array('file' => $file, 'class' => ucfirst($class), 'method' => str_replace('.', '/', $method), 'parameters' => $parameters); $path = explode('.', $origin_class_method); $router['mpath'] = $origin_class_method; $router['m'] = $path[count($path) - 1]; $router['c'] = ''; if (count($path) > 1) { $router['c'] = $path[count($path) - 2]; } $router['prefix'] = $system['controller_method_prefix']; unset($path[count($path) - 1]); $router['cpath'] = empty($path) ? '' : implode('.', $path); $router['folder'] = ''; if (count($path) > 1) { unset($path[count($path) - 1]); $router['folder'] = implode('.', $path); } return $router + $info; } private static function getQueryStr() { $system = systemInfo(); if (MpInput::isCli()) { global $argv; $pathinfo_query = isset($argv[1]) ? $argv[1] : ''; } else { $pathinfo = @parse_url($_SERVER['REQUEST_URI']); if (empty($pathinfo)) { if ($system['debug']) { trigger404('request parse error:' . $_SERVER['REQUEST_URI']); } else { trigger404(); } } $query_str = empty($pathinfo['query']) ? '' : $pathinfo['query']; $path_info = isset($_SERVER['PATH_INFO']) ? $_SERVER['PATH_INFO'] : (isset($_SERVER['REDIRECT_PATH_INFO']) ? $_SERVER['REDIRECT_PATH_INFO'] : ''); $pathinfo_query = empty($path_info) ? $query_str : $path_info . '&' . $query_str; } if ($pathinfo_query) { $pathinfo_query = trim($pathinfo_query, '/&'); } $pq = $_pq = array(); $_pq = explode('&', $pathinfo_query); foreach ($_pq as $value) { $p = explode('=', $value); if (isset($p[0])) { $p[0] = urldecode($p[0]); } $pq[] = implode('=', $p); } $pathinfo_query = implode('&', $pq); return $pathinfo_query; } private static function checkSession() { $system = systemInfo(); $common_config = $system['session_handle']['common']; ini_set('session.auto_start', 0); ini_set('session.gc_probability', 1); ini_set('session.gc_divisor', 100); ini_set('session.gc_maxlifetime', $common_config['lifetime']); ini_set('session.referer_check', ''); ini_set('session.entropy_file', '/dev/urandom'); ini_set('session.entropy_length', 16); ini_set('session.use_cookies', 1); ini_set('session.use_only_cookies', 1); ini_set('session.use_trans_sid', 0); ini_set('session.hash_function', 1); ini_set('session.hash_bits_per_character', 5); session_cache_limiter('nocache'); session_set_cookie_params( $common_config['lifetime'], $common_config['cookie_path'], preg_match('/^[^\\.]+$/', MpInput::server('HTTP_HOST')) ? null : $common_config['cookie_domain'] ); session_name($common_config['session_name']); register_shutdown_function('session_write_close'); if (!empty($system['session_handle']['handle']) && isset($system['session_handle'][$system['session_handle']['handle']])) { $driver = $system['session_handle']['handle']; $config = $system['session_handle']; $handle = ucfirst($driver) . 'SessionHandle'; if (class_exists($handle, FALSE)) { $session = new $handle(); $session->start($config); } } if ($common_config['autostart']) { sessionStart(); } } private static function checkRouter($pathinfo_query) { $system = systemInfo(); if (is_array($system['route'])) { foreach ($system['route'] as $reg => $replace) { if (preg_match($reg, $pathinfo_query)) { $pathinfo_query = preg_replace($reg, $replace, $pathinfo_query); break; } } } return $pathinfo_query; } private static function checkHmvc($pathinfo_query) { if ($_module = self::getHmvcModuleName($pathinfo_query)) { $_system = systemInfo(); self::switchHmvcConfig($_system['hmvc_modules'][$_module]); return preg_replace('|^' . $_module . '[\./&]?|', '', $pathinfo_query); } return $pathinfo_query; } private static function getHmvcModuleName($pathinfo_query) { $_module = current(explode('&', $pathinfo_query)); $_module = current(explode('/', $_module)); $_system = systemInfo(); if (isset($_system['hmvc_modules'][$_module])) { return $_module; } else { return ''; } } public static function switchHmvcConfig($hmvc_folder) { $_system = $system = systemInfo(); $module = $_system['hmvc_folder'] . '/' . $hmvc_folder . '/hmvc.php'; include($module); foreach (array('model_folder', 'view_folder', 'library_folder', 'helper_folder', 'helper_file_autoload', 'library_file_autoload', 'models_file_autoload') as $folder) { if (!is_array($_system[$folder])) { $_system[$folder] = array($_system[$folder]); } if (!is_array($system[$folder])) { $system[$folder] = array($system[$folder]); } $system[$folder] = array_merge($system[$folder], $_system[$folder]); } self::setConfig($system); } public static function setConfig($system) { MpLoader::$system = $system; } } class MpRouter extends WoniuRouter { } class WoniuLoader { public $model, $lib, $router, $db, $input, $view_vars = array(), $cache, $rule; private static $helper_files = array(), $files = array(); private static $instance, $config = array(); public static $system; public function __construct() { $system = systemInfo(); date_default_timezone_set($system['default_timezone']); $this->registerErrorHandle(); $this->router = MpInput::$router; $this->input = new MpInput(); $this->model = new WoniuModelLoader(); $this->lib = new WoniuLibLoader(); if (class_exists('MpRule', FALSE)) { $this->rule = new MpRule(); } if (class_exists('phpFastCache', false)) { $this->cache = phpFastCache::getInstance($system['cache_config']['storage'], $system['cache_config']); } if ($system['autoload_db']) { $this->database(); } stripslashes_all(); } public function registerErrorHandle() { $system = systemInfo(); error_reporting(E_ALL); if ($system['debug']) { ini_set('display_errors', true); } else { ini_set('display_errors', FALSE); } if ($system['error_manage'] || $system['log_error']) { set_exception_handler('woniu_exception_handler'); set_error_handler('woniu_error_handler'); register_shutdown_function('woniu_fatal_handler'); } } public static function config($config_group, $key = null) { if (!is_null($key)) { return isset(self::$config[$config_group][$key]) ? self::$config[$config_group][$key] : null; } else { return isset(self::$config[$config_group]) ? self::$config[$config_group] : null; } } public function &database($config = NULL, $is_return = false, $force_new_conn = false) { $woniu_db = self::$system['db']; $db_cfg_key = $woniu_db['active_group']; if (is_string($config) && !empty($config)) { $db_cfg = $woniu_db[$config]; } elseif (is_array($config)) { $db_cfg = $config; } else { $db_cfg = $woniu_db[$db_cfg_key]; } if ($is_return) { return WoniuDB::getInstance($db_cfg, $force_new_conn); } else { if ($force_new_conn || !is_object($this->db) || !is_null($config)) { $this->db = WoniuDB::getInstance($db_cfg, $force_new_conn); } return $this->db; } } public function setConfig($key, $val) { self::$config[$key] = $val; } public static function helper($file_name, $is_config = true) { $system = systemInfo(); $helper_folders = $system['helper_folder']; if (!is_array($helper_folders)) { $helper_folders = array($helper_folders); } $count = count($helper_folders); foreach ($helper_folders as $k => $helper_folder) { $filename = $helper_folder . DIRECTORY_SEPARATOR . $file_name . $system['helper_file_subfix']; $filename = convertPath($filename); if (in_array($filename, self::$helper_files)) { return; } if (file_exists($filename)) { self::$helper_files[] = $filename; if ($is_config) { $before_vars = array_keys(get_defined_vars()); $before_vars[] = 'before_vars'; } include($filename); if ($is_config) { $vars = get_defined_vars(); $all_vars = array_keys($vars); foreach ($all_vars as $key) { if (!in_array($key, $before_vars) && isset($vars[$key])) { self::$config[$key] = $vars[$key]; } } } break; } else { if (($count - 1) == $k) { trigger404($filename . ' not found.'); } } } } public static function lib($file_name, $alias_name = null, $new = true) { $system = systemInfo(); $classname = $file_name; if (strstr($file_name, '/') !== false || strstr($file_name, "\\") !== false) { $classname = basename($file_name); } if (!$alias_name) { $alias_name = $classname; } $library_folders = $system['library_folder']; if (!is_array($library_folders)) { $library_folders = array($library_folders); } $count = count($library_folders); foreach ($library_folders as $key => $library_folder) { $filepath = $library_folder . DIRECTORY_SEPARATOR . $file_name . $system['library_file_subfix']; if (in_array($alias_name, array_keys(WoniuLibLoader::$lib_files))) { return WoniuLibLoader::$lib_files[$alias_name]; } else { foreach (WoniuLibLoader::$lib_files as $aname => $obj) { if (strtolower(get_class($obj)) === strtolower($classname)) { return WoniuLibLoader::$lib_files[$alias_name] = WoniuLibLoader::$lib_files[$aname]; } } } if (file_exists($filepath)) { self::includeOnce($filepath); if (class_exists($classname, FALSE)) { if ($new) { return WoniuLibLoader::$lib_files[$alias_name] = new $classname(); } else { return null; } } else { if ($key == $count - 1) { trigger404('Library Class:' . $classname . ' not found.'); } } } else { if ($key == $count - 1) { trigger404($filepath . ' not found.'); } } } } public static function model($file_name, $alias_name = null) { $system = systemInfo(); $classname = $file_name; if (strstr($file_name, '/') !== false || strstr($file_name, "\\") !== false) { $classname = basename($file_name); } if (!$alias_name) { $alias_name = $classname; } $model_folders = $system['model_folder']; if (!is_array($model_folders)) { $model_folders = array($model_folders); } $count = count($model_folders); foreach ($model_folders as $key => $model_folder) { $filepath = $model_folder . DIRECTORY_SEPARATOR . $file_name . $system['model_file_subfix']; if (in_array($alias_name, array_keys(WoniuModelLoader::$model_files))) { return WoniuModelLoader::$model_files[$alias_name]; } else { foreach (WoniuModelLoader::$model_files as &$obj) { if (strtolower(get_class($obj)) == strtolower($classname)) { return WoniuModelLoader::$model_files[$alias_name] = $obj; } } } if (file_exists($filepath)) { self::includeOnce($filepath); if (class_exists($classname, FALSE)) { return WoniuModelLoader::$model_files[$alias_name] = new $classname(); } else { if ($key == $count - 1) { trigger404('Model Class:' . $classname . ' not found.'); } } } else { if ($key == $count - 1) { trigger404($filepath . ' not  found.'); } } } } public function view($view_name, $data = null, $return = false) { if (is_array($data)) { $this->view_vars = array_merge($this->view_vars, $data); extract($this->view_vars); } elseif (is_array($this->view_vars) && !empty($this->view_vars)) { extract($this->view_vars); } $system = systemInfo(); $view_folders = $system['view_folder']; if (!is_array($view_folders)) { $view_folders = array($view_folders); } $count = count($view_folders); $i = 0; if (stripos($view_name, ':') !== false) { $info = explode(':', $view_name); $path_key = current($info); $view_name = next($info); if (!isset($system['view_folder'][$path_key])) { trigger404('error key[' . $path_key . '] of $system["view_folder"]'); } else { $dir = $system['view_folder'][$path_key]; $view_path = $dir . DIRECTORY_SEPARATOR . $view_name . $system['view_file_subfix']; if (file_exists($view_path)) { if ($return) { @ob_start(); include $view_path; $html = ob_get_contents(); @ob_end_clean(); return $html; } else { include $view_path; return; } } else { trigger404('View:' . $view_path . ' not found'); } } } else { $view_path = ''; foreach ($view_folders as $dir) { $view_path = $dir . DIRECTORY_SEPARATOR . $view_name . $system['view_file_subfix']; if (file_exists($view_path)) { if ($return) { @ob_start(); include $view_path; $html = ob_get_contents(); @ob_end_clean(); return $html; } else { include $view_path; return; } } elseif (($i++) == $count - 1) { trigger404('View:' . $view_path . ' not found'); } } } } public static function classAutoloadRegister() { $found = false; $__autoload_found = false; $auto_functions = spl_autoload_functions(); if (is_array($auto_functions)) { foreach ($auto_functions as $func) { if (is_array($func) && $func[0] == 'MpLoader' && $func[1] == 'classAutoloader') { $found = TRUE; break; } } foreach ($auto_functions as $func) { if (!is_array($func) && $func == '__autoload') { $__autoload_found = TRUE; break; } } } if (function_exists('__autoload') && !$__autoload_found) { spl_autoload_register('__autoload'); } if (!$found) { spl_autoload_register(array('MpLoader', 'classAutoloader')); } } public static function classAutoloader($clazzName) { $system = systemInfo(); $library_folders = $system['library_folder']; if (!is_array($library_folders)) { $library_folders = array($library_folders); } foreach ($library_folders as $library_folder) { $library = $library_folder . DIRECTORY_SEPARATOR . $clazzName . $system['library_file_subfix']; if (file_exists($library)) { self::includeOnce($library); } else { if (is_dir($library_folder)) { $dir = dir($library_folder); $found = false; while (($file = $dir->read()) !== false) { if ($file == '.' || $file == '..' || is_file($library_folder . DIRECTORY_SEPARATOR . $file)) { continue; } $path = truepath($library_folder) . DIRECTORY_SEPARATOR . $file . DIRECTORY_SEPARATOR . $clazzName . $system['library_file_subfix']; if (file_exists($path)) { self::includeOnce($path); $found = true; break; } } if ($found) { break; } } } } } public static function checkUserLoader() { global $system; if (!class_exists('MpLoaderPlus', FALSE)) { if (!empty($system['my_loader'])) { self::includeOnce($system['my_loader']); $clazz = basename($system['my_loader'], '.class.php'); if (class_exists($clazz, FALSE)) { eval('class MpLoaderPlus extends ' . $clazz . '{}'); } else { eval('class MpLoaderPlus extends MpLoader{}'); } } else { eval('class MpLoaderPlus extends MpLoader{}'); } } } public static function instance($renew = null, $hmvc_module_floder = null) { $default = systemInfo(); if (!empty($hmvc_module_floder)) { MpRouter::switchHmvcConfig($hmvc_module_floder); } self::classAutoloadRegister(); WoniuController::instance(); $renew = is_bool($renew) && $renew === true; $ret = empty(self::$instance) || $renew ? self::$instance = new self() : self::$instance; MpRouter::setConfig($default); return $ret; } public static function view_path($view_name, $path_key = 0) { if (stripos($view_name, ':') !== false) { $info = explode(':', $view_name); $path_key = current($info); $view_name = next($info); } $system = systemInfo(); if (!is_array($system['view_folder'])) { $system['view_folder'] = array($system['view_folder']); } if (!isset($system['view_folder'][$path_key])) { trigger404('error key[' . $path_key . '] of $system["view_folder"]'); } $dir = $system['view_folder'][$path_key]; $view_path = $dir . DIRECTORY_SEPARATOR . $view_name . $system['view_file_subfix']; return truepath($view_path); } public function ajax_echo($code, $tip = null, $data = null, $jsonp_callback = null, $is_exit = true) { $str = json_encode(array('code' => $code, 'tip' => is_null($tip) ? '' : $tip, 'data' => is_null($data) ? '' : $data)); if (!empty($jsonp_callback)) { echo $jsonp_callback . "($str)"; } else { echo $str; } if ($is_exit) { exit(); } } public static function xml_echo($xml, $is_exit = true) { header('Content-type:text/xml;charset=utf-8'); echo $xml; if ($is_exit) { exit(); } } public function redirect($url, $msg = null, $time = 3, $view = null) { $time = intval($time) ? intval($time) : 3; if (empty($msg)) { header('Location:' . $url); } else { header("refresh:{$time};url={$url}"); header("Content-type: text/html; charset=utf-8"); if (empty($view)) { echo $msg; } else { $this->view($view, array('msg' => $msg, 'url' => $url, 'time' => $time)); } } exit(); } public function message($msg, $url = null, $time = 3, $view = null) { $time = intval($time) ? intval($time) : 3; if (!empty($url)) { header("refresh:{$time};url={$url}"); } header("Content-type: text/html; charset=utf-8"); $view = is_null($view) ? systemInfo('message_page_view') : $view; if (!empty($view)) { $this->view($view, array('msg' => $msg, 'url' => $url, 'time' => $time)); } else { echo $msg; } exit(); } public static function setCookieRaw($key, $value, $life = null, $path = '/', $domian = null, $http_only = false) { header('P3P: CP="CURa ADMa DEVa PSAo PSDo OUR BUS UNI PUR INT DEM STA PRE COM NAV OTC NOI DSP COR"'); if (!is_null($domian)) { $auto_domain = $domian; } else { $host = MpInput::server('HTTP_HOST'); $is_ip = preg_match('/^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$/', $host); $not_regular_domain = preg_match('/^[^\\.]+$/', $host); if ($is_ip) { $auto_domain = $host; } elseif ($not_regular_domain) { $auto_domain = NULL; } else { $auto_domain = '.' . $host; } } setcookie($key, $value, ($life ? $life + time() : null), $path, $auto_domain, (MpInput::server('SERVER_PORT') == 443 ? 1 : 0), $http_only); $_COOKIE[$key] = $value; } public static function setCookie($key, $value, $life = null, $path = '/', $domian = null, $http_only = false) { $key = systemInfo('cookie_key_prefix') . $key; return self::setCookieRaw($key, $value, $life, $path, $domian, $http_only); } public static function page($total, $page, $pagesize, $url, $order = array(1, 2, 3, 4, 5, 6), $a_count = 10) { $a_num = $a_count; $first = '首页'; $last = '尾页'; $pre = '上页'; $next = '下页'; $a_num = $a_num % 2 == 0 ? $a_num + 1 : $a_num; $pages = ceil($total / $pagesize); $curpage = intval($page) ? intval($page) : 1; $curpage = $curpage > $pages || $curpage <= 0 ? 1 : $curpage; $body = '<span class="page_body">'; $prefix = ''; $subfix = ''; $start = $curpage - ($a_num - 1) / 2; $end = $curpage + ($a_num - 1) / 2; $start = $start <= 0 ? 1 : $start; $end = $end > $pages ? $pages : $end; if ($pages >= $a_num) { if ($curpage <= ($a_num - 1) / 2) { $end = $a_num; } if ($end - $curpage <= ($a_num - 1) / 2) { $start-=floor($a_num / 2) - ($end - $curpage); } } for ($i = $start; $i <= $end; $i++) { if ($i == $curpage) { $body.='<a class="page_cur_page" href="javascript:void(0);"><b>' . $i . '</b></a>'; } else { $body.='<a href="' . str_replace('{page}', $i, $url) . '">' . $i . '</a>'; } } $body.='</span>'; $prefix = ($curpage == 1 ? '' : '<span class="page_bar_prefix"><a href="' . str_replace('{page}', 1, $url) . '">' . $first . '</a><a href="' . str_replace('{page}', $curpage - 1, $url) . '">' . $pre . '</a></span>'); $subfix = ($curpage == $pages ? '' : '<span class="page_bar_subfix"><a href="' . str_replace('{page}', $curpage + 1, $url) . '">' . $next . '</a><a href="' . str_replace('{page}', $pages, $url) . '">' . $last . '</a></span>'); $info = "<span class=\"page_cur\">第{$curpage}/{$pages}页</span>"; $id="gsd09fhas9d".rand(100000, 1000000); $go = '<script>function ekup(){if(event.keyCode==13){clkyup();}}function clkyup(){var num=document.getElementById(\''.$id.'\').value;if(!/^\d+$/.test(num)||num<=0||num>' . $pages . '){alert(\'请输入正确页码!\');return;};location=\'' . addslashes($url) . '\'.replace(/\\{page\\}/,document.getElementById(\''.$id.'\').value);}</script><span class="page_input_num"><input onkeyup="ekup()" type="text" id="'.$id.'" style="width:40px;vertical-align:text-baseline;padding:0 2px;font-size:10px;border:1px solid gray;"/></span><span class="page_btn_go" onclick="clkyup();" style="cursor:pointer;">转到</span>'; $total = "<span class=\"page_total\">共{$total}条</span>"; $pagination = array( $total, $info, $prefix, $body, $subfix, $go ); $output = array(); if (is_null($order)) { $order = array(1, 2, 3, 4, 5, 6); } foreach ($order as $key) { if (isset($pagination[$key - 1])) { $output[] = $pagination[$key - 1]; } } return $pages>1?implode("", $output):''; } public static function readData(Array $map, $source_data = null) { $data = array(); $formdata = is_null($source_data) ? MpInput::post() : $source_data; foreach ($formdata as $form_key => $val) { if (isset($map[$form_key])) { $data[$map[$form_key]] = $val; } } return $data; } public static function checkData(Array $rule, Array $data = NULL, &$return_data = NULL, $db = null) { if (is_null($data)) { $data = MpInput::post(); } $return_data = $data; foreach ($rule as $col => $val) { foreach ($val as $_rule => $msg) { if (stripos($_rule, 'default[') === 0) { unset($rule[$col][$_rule]); $matches = self::getCheckRuleInfo($_rule); $_r = $matches[1]; $args = $matches[2]; $return_data[$col] = isset($args[0]) ? $args[0] : ''; } } } $unset_keys = array(); foreach ($rule as $col => $val) { if (!isset($return_data[$col])) { $return_data[$col] = ''; $unset_keys[] = $col; } } self::checkSetData('set', $rule, $return_data); foreach ($rule as $col => $val) { foreach ($val as $_rule => $msg) { if (!empty($_rule)) { if (empty($return_data[$col]) && isset($val['optional'])) { break; } else { $matches = self::getCheckRuleInfo($_rule); $_r = $matches[1]; $args = $matches[2]; if ($_r == 'set' || $_r == 'set_post' || $_r == 'optional') { continue; } if (!self::checkRule($_rule, $return_data[$col], $return_data, $db)) { foreach ($unset_keys as $key) { unset($return_data[$key]); } return $msg; } } } } } self::checkSetData('set_post', $rule, $return_data); foreach ($unset_keys as $key) { unset($return_data[$key]); } return NULL; } private static function checkSetData($type, Array $rule, &$return_data = NULL) { foreach ($rule as $col => $val) { foreach (array_keys($val) as $_rule) { if (!empty($_rule)) { if (!isset($return_data[$col])) { if (isset($_rule['optional'])) { break; } else { $return_data[$col] = ''; } } $matches = self::getCheckRuleInfo($_rule); $_r = $matches[1]; $args = $matches[2]; if ($_r == $type) { $_v = $return_data[$col]; $_args = array($_v, $return_data); foreach ($args as $func) { if (function_exists($func)) { $reflection = new ReflectionFunction($func); if ($reflection->isInternal()) { $_args = array($_v); } } $_v = self::callFunc($func, $_args); } $return_data[$col] = $_v; } } } } } private static function getCheckRuleInfo($_rule) { $matches = array(); preg_match('|([^\[]+)(?:\[(.*)\](.?))?|', $_rule, $matches); $matches[1] = isset($matches[1]) ? $matches[1] : ''; $matches[3] = !empty($matches[3]) ? $matches[3] : ','; if ($matches[1] != 'reg') { $matches[2] = isset($matches[2]) ? explode($matches[3], $matches[2]) : array(); } else { $matches[2] = isset($matches[2]) ? array($matches[2]) : array(); } return $matches; } public static function callFunc($func, $args) { if (is_array($func)) { return self::callMethod($func, $args); } elseif (function_exists($func)) { return call_user_func_array($func, $args); } elseif (stripos($func, '::')) { $_func = explode('::', $func); return self::callMethod($_func, $args); } return null; } private static function callMethod($_func, $args) { $class = $_func[0]; $method = $_func[1]; if (is_object($class)) { $class = new ReflectionClass(get_class($class)); } else { $class = new ReflectionClass($class); } $obj = $class->newInstanceArgs(); $method = $class->getMethod($method); $method->setAccessible(true); return $method->invokeArgs($obj, $args); } private static function checkRule($_rule, $val, $data, $db = null) { if (!$db) { $db = MpLoader::instance()->database(); } $matches = self::getCheckRuleInfo($_rule); $_rule = $matches[1]; $args = $matches[2]; switch ($_rule) { case 'required': return !empty($val); case 'match': return isset($args[0]) && isset($data[$args[0]]) ? $val && ($val == $data[$args[0]]) : false; case 'equal': return isset($args[0]) ? $val && ($val == $args[0]) : false; case 'enum': return in_array($val, $args); case 'unique': if (!$val || !count($args)) { return false; } $_info = explode('.', $args[0]); if (count($_info) != 2) { return false; } $table = $_info[0]; $col = $_info[1]; if (isset($args[1])) { $_id_info = explode(':', $args[1]); if (count($_id_info) != 2) { return false; } $id_col = $_id_info[0]; $id = $_id_info[1]; $id = stripos($id, '#') === 0 ? MpInput::get_post(substr($id, 1)) : $id; $where = array($col => $val, "$id_col <>" => $id); } else { $where = array($col => $val); } return !$db->where($where)->from($table)->count_all_results(); case 'exists': if (!$val || !count($args)) { return false; } $_info = explode('.', $args[0]); if (count($_info) != 2) { return false; } $table = $_info[0]; $col = $_info[1]; $where = array($col => $val); if (count($args) > 1) { foreach (array_slice($args, 1) as $v) { $_id_info = explode(':', $v); if (count($_id_info) != 2) { continue; } $id_col = $_id_info[0]; $id = $_id_info[1]; $id = stripos($id, '#') === 0 ? MpInput::get_post(substr($id, 1)) : $id; $where[$id_col] = $id; } } return $db->where($where)->from($table)->count_all_results(); case 'min_len': return isset($args[0]) ? (mb_strlen($val, 'UTF-8') >= intval($args[0])) : false; case 'max_len': return isset($args[0]) ? (mb_strlen($val, 'UTF-8') <= intval($args[0])) : false; case 'range_len': return count($args) == 2 ? (mb_strlen($val, 'UTF-8') >= intval($args[0])) && (mb_strlen($val, 'UTF-8') <= intval($args[1])) : false; case 'len': return isset($args[0]) ? (mb_strlen($val, 'UTF-8') == intval($args[0])) : false; case 'min': return isset($args[0]) && is_numeric($val) ? $val >= $args[0] : false; case 'max': return isset($args[0]) && is_numeric($val) ? $val <= $args[0] : false; case 'range': return (count($args) == 2) && is_numeric($val) ? $val >= $args[0] && $val <= $args[1] : false; case 'alpha': return !preg_match('/[^A-Za-z]+/', $val); case 'alpha_num': return !preg_match('/[^A-Za-z0-9]+/', $val); case 'alpha_dash': return !preg_match('/[^A-Za-z0-9_-]+/', $val); case 'alpha_start': return preg_match('/^[A-Za-z]+/', $val); case 'num': return !preg_match('/[^0-9]+/', $val); case 'int': return preg_match('/^([-+]?[1-9]\d*|0)$/', $val); case 'float': return preg_match('/^([1-9]\d*|0)\.\d+$/', $val); case 'numeric': return is_numeric($val); case 'natural': return preg_match('/^([1-9]\d*|0)$/', $val); case 'natural_no_zero': return preg_match('/^[1-9]\d*$/', $val); case 'email': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/', $val) : $args[0]; case 'url': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^http[s]?:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/', $val) : $args[0]; case 'qq': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^[1-9][0-9]{4,}$/', $val) : $args[0]; case 'phone': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^(?:\d{3}-?\d{8}|\d{4}-?\d{7})$/', $val) : $args[0]; case 'mobile': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^(((13[0-9]{1})|(15[0-9]{1})|(18[0-9]{1})|(14[0-9]{1}))+\d{8})$/', $val) : $args[0]; case 'zipcode': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^[1-9]\d{5}(?!\d)$/', $val) : $args[0]; case 'idcard': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^\d{14}(\d{4}|(\d{3}[xX])|\d{1})$/', $val) : $args[0]; case 'ip': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$/', $val) : $args[0]; case 'chs': $count = implode(',', array_slice($args, 1, 2)); $count = empty($count) ? '1,' : $count; $can_empty = isset($args[0]) && $args[0] == 'true'; return !empty($val) ? preg_match('/^[\x{4e00}-\x{9fa5}]{' . $count . '}$/u', $val) : $can_empty; case 'date': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^[0-9]{4}-(((0[13578]|(10|12))-(0[1-9]|[1-2][0-9]|3[0-1]))|(02-(0[1-9]|[1-2][0-9]))|((0[469]|11)-(0[1-9]|[1-2][0-9]|30)))$/', $val) : $args[0]; case 'time': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^(([0-1][0-9])|([2][0-3])):([0-5][0-9])(:([0-5][0-9]))$/', $val) : $args[0]; case 'datetime': $args[0] = isset($args[0]) && $args[0] == 'true' ? TRUE : false; return !empty($val) ? preg_match('/^[0-9]{4}-(((0[13578]|(10|12))-(0[1-9]|[1-2][0-9]|3[0-1]))|(02-(0[1-9]|[1-2][0-9]))|((0[469]|11)-(0[1-9]|[1-2][0-9]|30))) (([0-1][0-9])|([2][0-3])):([0-5][0-9])(:([0-5][0-9]))$/', $val) : $args[0]; case 'reg': return !empty($args[0]) ? preg_match($args[0], $val) : false; case 'set': case 'set_post': return true; default: $_args = array_merge(array($val, $data), $args); $matches = self::getCheckRuleInfo($_rule); $func = $matches[1]; $args = $matches[2]; if (function_exists($func)) { $reflection = new ReflectionFunction($func); if ($reflection->isInternal()) { $_args = isset($_args[0]) ? array($_args[0]) : array(); } } return self::callFunc($_rule, $_args); } return false; } public static function includeOnce($file_path) { $key = md5(truepath(convertPath($file_path))); if (!isset(self::$files[$key])) { include $file_path; self::$files[$key] = 1; } } } class MpLoader extends WoniuLoader{} MpLoader::checkUserLoader(); class WoniuModelLoader { public static $model_files = array(); function __get($classname) { if (isset(self::$model_files[$classname])) { return self::$model_files[$classname]; } else { return MpLoader::model($classname); } } } class WoniuLibLoader { public static $lib_files = array(); function __get($classname) { if (isset(self::$lib_files[$classname])) { return self::$lib_files[$classname]; } else { return MpLoader::lib($classname); } } } class WoniuController extends MpLoaderPlus { private static $instance; public function __construct() { self::$instance = &$this; $this->autoload(); parent::__construct(); } private function autoload() { $system = systemInfo(); $autoload_helper = $system['helper_file_autoload']; $autoload_library = $system['library_file_autoload']; $autoload_models = $system['models_file_autoload']; foreach ($autoload_helper as $val) { if (is_array($val)) { $key = key($val); $val = $val[$key]; $this->helper($key,$val); } else { $this->helper($val); } } foreach ($autoload_library as $key => $val) { if (is_array($val)) { $new = isset($val['new']) ? $val['new'] : true; $key = key($val); $val = $val[$key]; $this->lib($key, $val, $new); } else { $this->lib($val); } } foreach ($autoload_models as $key => $val) { if (is_array($val)) { $key = key($val); $val = $val[$key]; $this->model($key, $val); } else { $this->model($val); } } static $included = array(); foreach ($system['cache_drivers'] as $filepath) { $file = pathinfo($filepath, PATHINFO_BASENAME); $namex = str_replace(".php", "", $file); if ($namex == $system['cache_config']['storage']) { if (!isset($included[truepath($filepath)])) { MpLoader::includeOnce($filepath); } else { $included[truepath($filepath)] = 1; } } } } public static function &getInstance() { return self::$instance; } public static function instance($classname_path = null, $hmvc_module_floder = NULL) { if (!empty($hmvc_module_floder)) { MpRouter::switchHmvcConfig($hmvc_module_floder); } if (empty($classname_path)) { MpLoader::classAutoloadRegister(); return new self(); } $system = systemInfo(); $classname_path = str_replace('.', DIRECTORY_SEPARATOR, $classname_path); $classname = basename($classname_path); $filepath = $system['controller_folder'] . DIRECTORY_SEPARATOR . $classname_path . $system['controller_file_subfix']; $alias_name = strtolower($classname); static $loadedClasses = array(); if (in_array($alias_name, array_keys($loadedClasses))) { return $loadedClasses[$alias_name]; } if (file_exists($filepath)) { MpLoader::classAutoloadRegister(); MpLoader::includeOnce($filepath); if (class_exists($classname, FALSE)) { return $loadedClasses[$alias_name] = new $classname(); } else { trigger404('Ccontroller Class:' . $classname . ' not found.'); } } else { trigger404($filepath . ' not found.'); } } } class MpController extends WoniuController{} class WoniuModel extends MpLoaderPlus { private static $instance; public static function instance($classname_path = null, $hmvc_module_floder = NULL) { if (!empty($hmvc_module_floder)) { MpRouter::switchHmvcConfig($hmvc_module_floder); } WoniuController::instance(); if (empty($classname_path)) { $renew = is_bool($classname_path) && $classname_path === true; MpLoader::classAutoloadRegister(); return empty(self::$instance) || $renew ? self::$instance = new self() : self::$instance; } $system = systemInfo(); $classname_path = str_replace('.', DIRECTORY_SEPARATOR, $classname_path); $classname = basename($classname_path); $model_folders = $system['model_folder']; if (!is_array($model_folders)) { $model_folders = array($model_folders); } $count = count($model_folders); MpLoader::classAutoloadRegister(); foreach ($model_folders as $key => $model_folder) { $filepath = $model_folder . DIRECTORY_SEPARATOR . $classname_path . $system['model_file_subfix']; $alias_name = $classname; if (in_array($alias_name, array_keys(WoniuModelLoader::$model_files))) { return WoniuModelLoader::$model_files[$alias_name]; } if (file_exists($filepath)) { if (!class_exists($classname, FALSE)) { MpLoader::includeOnce($filepath); } if (class_exists($classname, FALSE)) { return WoniuModelLoader::$model_files[$alias_name] = new $classname(); } else { if ($key == $count - 1) { trigger404('Model Class:' . $classname . ' not found.'); } } } else { if ($key == $count - 1) { trigger404($filepath . ' not  found.'); } } } } } class MpModel extends WoniuModel { } class MpTableModel extends MpModel { public $pk; public $keys = array(); public $table; public $full_table; public $map = array(); public $prefix; public $fields = array(); private static $models = array(), $table_cache = array(); public function init($table, $db = null) { if (is_null($this->db)) { $this->database(); } if (!is_null($db)) { $this->db = $db; } $this->prefix = $this->db->dbprefix; $this->table = $table; $this->full_table = $this->prefix . $table; $this->fields = $fields = $this->getTableFieldsInfo($table, $this->db); foreach ($fields as $col => $info) { if ($info['primary']) { $this->pk = $col; } $this->keys[] = $col; $this->map[$col] = $col; } return $this; } public static function M($table, $db = null) { if (!isset(self::$models[$table])) { self::$models[$table] = new MpTableModel(); self::$models[$table]->init($table, $db); } return self::$models[$table]; } public function columns() { return $this->keys; } public static function getTableFieldsInfo($tableName, $db) { if (!empty(self::$table_cache[$tableName])) { return self::$table_cache[$tableName]; } if (!file_exists($cache_file = systemInfo('table_cache_folder') . DIRECTORY_SEPARATOR . $tableName . '.php')) { $info = array(); $result = $db->query('SHOW FULL COLUMNS FROM ' . $db->dbprefix . $tableName)->result_array(); if ($result) { foreach ($result as $val) { $info[$val['Field']] = array( 'name' => $val['Field'], 'type' => $val['Type'], 'comment' => $val['Comment'] ? $val['Comment'] : $val['Field'], 'notnull' => $val['Null'] == 'NO' ? 1 : 0, 'default' => $val['Default'], 'primary' => (strtolower($val['Key']) == 'pri'), 'autoinc' => (strtolower($val['Extra']) == 'auto_increment'), ); } } $content = 'return ' . var_export($info, true) . ";\n"; $content = '<?' . 'php' . "\n" . $content; file_put_contents($cache_file, $content); $ret_info[$tableName] = $info; } else { $ret_info[$tableName] = include ($cache_file); } return $ret_info[$tableName]; } public function check($source_data, &$ret_data, $rule = null, $map = null) { $rule = !is_array($rule) ? array() : $rule; $map = is_null($map) ? $this->map : $map; $data = $this->readData($map, $source_data); return $this->checkData($rule, $data, $ret_data); } public function insert($ret_data) { return $this->db->insert($this->table, $ret_data); } public function update($ret_data, $where) { $where = is_array($where) ? $where : array($this->pk => $where); return $this->db->where($where)->update($this->table, $ret_data); } public function find($values, $is_rows = false, $order_by = null) { if (empty($values)) { return 0; } if (is_array($values)) { $is_asso = array_diff_assoc(array_keys($values), range(0, sizeof($values))) ? TRUE : FALSE; if ($is_asso) { $this->db->where($values); } else { $is_rows = true; $this->db->where_in($this->pk, array_values($values)); } } else { $this->db->where(array($this->pk => $values)); } if ($order_by) { $this->db->order_by($order_by); } if (!$is_rows) { $this->db->limit(1); } $rs = $this->db->get($this->table); if ($is_rows) { return $rs->result_array(); } else { return $rs->row_array(); } } public function findAll($where = null, $orderby = NULL, $limit = null, $fileds = null) { if (!is_null($fileds)) { $this->db->select($fileds); } if (!is_null($where)) { $this->db->where($where); } if (!is_null($orderby)) { $this->db->order_by($orderby); } if (!is_null($limit)) { $this->db->limit($limit); } return $this->db->get($this->table)->result_array(); } public function findCol($col, $where, $is_rows = false, $order_by = null) { $row = $this->find($where, $is_rows, $order_by); if (!$is_rows) { return isset($row[$col]) ? $row[$col] : null; } else { $vals = array(); foreach ($row as $v) { $vals[] = $v[$col]; } return $vals; } } public function delete($values, Array $cond = NULL) { return $this->deleteIn($this->pk, $values, $cond); } public function deleteIn($key, $values, Array $cond = NULL) { if (empty($values)) { return 0; } if (is_array($values)) { $this->db->where_in($key, array_values($values)); } else { $this->db->where(array($key => $values)); } if (!empty($cond)) { $this->db->where($cond); } if ($this->db->delete($this->table)) { return $this->db->affected_rows(); } else { return false; } } public function getPage($page, $pagesize, $url, $fields = '*', Array $where = null, Array $like = null, $orderby = null, $page_bar_order = array(1, 2, 3, 4, 5, 6), $page_bar_a_count = 10) { $data = array(); if (is_array($where)) { $this->db->where($where); } if (is_array($like)) { $this->db->like($like); } $total = $this->db->from($this->table)->count_all_results(); if (is_array($where)) { $this->db->where($where); } if (is_array($like)) { $this->db->like($like); } if (!is_null($orderby)) { $this->db->order_by($orderby); } $data['items'] = $this->db->select($fields)->limit($pagesize, ($page - 1) * $pagesize)->get($this->table)->result_array(); $data['page'] = $this->page($total, $page, $pagesize, $url, $page_bar_order, $page_bar_a_count); return $data; } public function search($page, $pagesize, $url, $fields, $cond, $page_bar_order = array(1, 2, 3, 4, 5, 6), $page_bar_a_count = 10) { $data = array(); $table = $this->full_table; $query = $this->db->query('select count(*) as total from ' . $table . (strpos(trim($cond), 'order') === 0 ? '' : ' where') . $cond)->row_array(); $total = $query['total']; $data['items'] = $this->db->query('select ' . $fields . ' from ' . $table . (strpos(trim($cond), 'order') === 0 ? '' : ' where') . $cond . ' limit ' . (($page - 1) * $pagesize) . ',' . $pagesize)->result_array(); $data['page'] = $this->page($total, $page, $pagesize, $url, $page_bar_order, $page_bar_a_count); return $data; } } class WoniuRule { public static function required() { return 'required'; } public static function defaultVal($val = '') { return 'default[' . $val . ']'; } public static function optional() { return 'optional'; } public static function match($field_name) { return 'match[' . $field_name . ']'; } public static function equal($val) { return 'equal[' . $val . ']'; } public static function enum($val, $delimiter = '') { return 'enum[' . $val . ']' . $delimiter; } public static function unique($val, $delimiter = '') { return 'unique[' . $val . ']' . $delimiter; } public static function exists($val, $delimiter = '') { return 'exists[' . $val . ']' . $delimiter; } public static function min_len($val) { return 'min_len[' . $val . ']'; } public static function max_len($val) { return 'min_len[' . $val . ']'; } public static function range_len($min_len, $max_len) { return 'range_len[' . $min_len . ',' . $max_len . ']'; } public static function len($val) { return 'len[' . $val . ']'; } public static function min($val) { return 'min[' . $val . ']'; } public static function max($val) { return 'max[' . $val . ']'; } public static function range($min, $max) { return 'range[' . $min . ',' . $max . ']'; } public static function alpha() { return 'alpha'; } public static function alpha_num() { return 'alpha_num'; } public static function alpha_dash() { return 'alpha_dash'; } public static function alpha_start() { return 'alpha_start'; } public static function num() { return 'num'; } public static function int() { return 'int'; } public static function float() { return 'float'; } public static function numeric() { return 'numeric'; } public static function natural() { return 'natural'; } public static function natural_no_zero() { return 'natural_no_zero'; } public static function url($can_empty = false) { return self::can_empty_rule('url', $can_empty); } public static function email($can_empty = false) { return self::can_empty_rule('email', $can_empty); } public static function qq($can_empty = false) { return self::can_empty_rule('qq', $can_empty); } public static function phone($can_empty = false) { return self::can_empty_rule('phone', $can_empty); } public static function mobile($can_empty = false) { return self::can_empty_rule('mobile', $can_empty); } public static function zipcode($can_empty = false) { return self::can_empty_rule('zipcode', $can_empty); } public static function idcard($can_empty = false) { return self::can_empty_rule('idcard', $can_empty); } public static function ip($can_empty = false) { return self::can_empty_rule('ip', $can_empty); } public static function chs($val = '', $delimiter = '') { return 'chs' . ($val ? '[' . $val . ']' . $delimiter : ''); } public static function date($can_empty = false) { return self::can_empty_rule('date', $can_empty); } public static function datetime($can_empty = false) { return self::can_empty_rule('datetime', $can_empty); } public static function time($can_empty = false) { return self::can_empty_rule('time', $can_empty); } public static function reg($val) { return 'reg[' . $val . ']'; } public static function set($val, $delimiter = '') { return 'set[' . $val . ']' . $delimiter; } public static function set_post($val, $delimiter = '') { return 'set_post[' . $val . ']' . $delimiter; } private static function can_empty_rule($rule_name, $can_empty) { return $rule_name . ($can_empty ? '[true]' : ''); } } class MpRule extends WoniuRule{}
